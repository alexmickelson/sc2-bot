@using SC2APIProtocol
@using Web.Services
@using Web.Components.Shared
@inject ClientManager clientManager

<div class="p-4">
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Host IP</label>
    <input type="text"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="hostIp" placeholder="127.0.0.1" />
  </div>

  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Server Game Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="serverGamePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Server Base Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="serverBasePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Client 1 Game Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="client1GamePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Client 1 Base Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="client1BasePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Client 2 Game Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="client2GamePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Client 2 Base Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="client2BasePort" />
  </div>
  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Shared Port</label>
    <input type="number"
      class="block w-full px-3 py-2 text-base text-gray-50 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
      @bind="sharedPort" />
  </div>

  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">My Race</label>
    <ButtonSelect TValue="Race" @bind-Value="myRace" Options="raceOptions" />
  </div>

  <InterfaceOptionsSelector Options="@InterfaceOptions" OnOptionsChanged="HandleOptionsChanged" />

  <button
    class="px-4 py-2 rounded font-semibold transition-colors duration-200 bg-yellow-500 text-black hover:bg-yellow-600 mt-3"
    @onclick="HandleJoinGame">Join Game</button>

  @if (!string.IsNullOrEmpty(errorMessage))
  {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-2">@errorMessage</div>
  }
</div>

@code {
  [Parameter] public EventCallback OnGameJoined { get; set; }
  [Parameter] public string Key { get; set; } = "";

  private SC2Client sc2Client = default!;
  private string hostIp = "127.0.0.1";
  private int serverGamePort = 5011;
  private int serverBasePort = 5012;
  private int client1GamePort = 5013;
  private int client1BasePort = 5014;
  private int client2GamePort = 5015;
  private int client2BasePort = 5016;
  private int sharedPort = 5017;
  private Race myRace = Race.Terran;
  private string errorMessage = "";
  private InterfaceOptions InterfaceOptions = new();

  private Dictionary<Race, string> raceOptions = new()
{
{ Race.Terran, "Terran" },
{ Race.Zerg, "Zerg" },
{ Race.Protoss, "Protoss" },
{ Race.Random, "Random" }
};

  protected override void OnInitialized()
  {
    var group = clientManager.GetOrCreateGroup(Key);
    sc2Client = group.SC2Client;

    // Initialize default options
    InterfaceOptions = new InterfaceOptions
    {
      Raw = true,
      Score = true,
      FeatureLayer = new SpatialCameraSetup
      {
        Width = 24,
        Resolution = new Size2DI { X = 64, Y = 64 },
        MinimapResolution = new Size2DI { X = 64, Y = 64 }
      },
      Render = new SpatialCameraSetup
      {
        Resolution = new Size2DI { X = 800, Y = 600 },
        MinimapResolution = new Size2DI { X = 300, Y = 300 }
      }
    };
  }

  private void HandleOptionsChanged(InterfaceOptions options)
  {
    InterfaceOptions = options;
  }

  private async Task HandleJoinGame()
  {
    errorMessage = "";
    try
    {
      // Ensure defaults are set if objects exist but resolutions are missing
      if (InterfaceOptions.Render != null)
      {
        InterfaceOptions.Render.Resolution ??= new Size2DI { X = 800, Y = 600 };
        InterfaceOptions.Render.MinimapResolution ??= new Size2DI { X = 300, Y = 300 };
      }

      if (InterfaceOptions.FeatureLayer != null)
      {
        InterfaceOptions.FeatureLayer.Width = InterfaceOptions.FeatureLayer.Width == 0 ? 24 :
        InterfaceOptions.FeatureLayer.Width;
        InterfaceOptions.FeatureLayer.Resolution ??= new Size2DI { X = 64, Y = 64 };
        InterfaceOptions.FeatureLayer.MinimapResolution ??= new Size2DI { X = 64, Y = 64 };
      }

      var request = new RequestJoinGame
      {
        Race = myRace,
        Options = InterfaceOptions,
        ServerPorts = new PortSet { GamePort = serverGamePort, BasePort = serverBasePort },
        ClientPorts = {
new PortSet { GamePort = client1GamePort, BasePort = client1BasePort },
new PortSet { GamePort = client2GamePort, BasePort = client2BasePort }
},
        HostIp = hostIp,
        SharedPort = sharedPort
      }; // For multiplayer, we usually need client ports too?
         // The SC2 protocol documentation says:
         // server_ports: Do not set in the single-player case.
         // client_ports: Do not set in the single-player case.
         // shared_port:

      // If we are joining a game hosted by another client, we need to specify ports.
      // Assuming 2 player game for now.

      // But wait, RequestJoinGame is sent to the LOCAL SC2 client.
      // The LOCAL SC2 client then connects to the HOST IP.

      var response = await sc2Client.SendRequestAsync(new Request { JoinGame = request });

      if (response.Status == Status.InGame)
      {
        await OnGameJoined.InvokeAsync();
      }
      else
      {
        errorMessage = $"Failed to join game. Status: {response.Status}";
        if (response.Error.Count > 0)
        {
          errorMessage += " Errors: " + string.Join(", ", response.Error);
        }
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error while joining game: {ex.Message}";
    }
  }
}