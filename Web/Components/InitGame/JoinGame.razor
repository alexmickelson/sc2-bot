@using SC2APIProtocol
@using Web.Services
@inject SC2Client SC2Client

<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">Join Game</h5>

    <div class="mb-3">
      <label class="form-label">My Race</label>
      <ButtonSelect TValue="Race" @bind-Value="myRace" Options="raceOptions" />
    </div>

    <InterfaceOptionsSelector Options="@InterfaceOptions" OnOptionsChanged="HandleOptionsChanged" />

    <button class="btn btn-warning mt-3" @onclick="HandleJoinGame">Join Game</button>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="alert alert-danger mt-2">@errorMessage</div>
    }
  </div>
</div>

@code {
  private InterfaceOptions InterfaceOptions = new();
  [Parameter] public EventCallback OnGameJoined { get; set; }
  [Parameter] public bool IsMultiplayer { get; set; }

  private Race myRace = Race.Terran;
  private string errorMessage = "";

  private Dictionary<Race, string> raceOptions = new()
{
{ Race.Terran, "Terran" },
{ Race.Zerg, "Zerg" },
{ Race.Protoss, "Protoss" },
{ Race.Random, "Random" }
};

  protected override void OnInitialized()
  {
    // Initialize default options
    InterfaceOptions = new InterfaceOptions
    {
      Raw = true,
      Score = true,
      FeatureLayer = new SpatialCameraSetup
      {
        Width = 24,
        Resolution = new Size2DI { X = 64, Y = 64 },
        MinimapResolution = new Size2DI { X = 64, Y = 64 }
      },
      Render = new SpatialCameraSetup
      {
        Resolution = new Size2DI { X = 800, Y = 600 },
        MinimapResolution = new Size2DI { X = 300, Y = 300 }
      }
    };
  }

  private async Task HandleJoinGame()
  {
    errorMessage = "";
    try
    {
      // Ensure defaults are set if objects exist but resolutions are missing
      if (InterfaceOptions.Render != null)
      {
        InterfaceOptions.Render.Resolution ??= new Size2DI { X = 800, Y = 600 };
        InterfaceOptions.Render.MinimapResolution ??= new Size2DI { X = 300, Y = 300 };
      }

      if (InterfaceOptions.FeatureLayer != null)
      {
        InterfaceOptions.FeatureLayer.Width = InterfaceOptions.FeatureLayer.Width == 0 ? 24 :
        InterfaceOptions.FeatureLayer.Width;
        InterfaceOptions.FeatureLayer.Resolution ??= new Size2DI { X = 64, Y = 64 };
        InterfaceOptions.FeatureLayer.MinimapResolution ??= new Size2DI { X = 64, Y = 64 };
      }

      var request = new RequestJoinGame
      {
        Race = myRace,
        Options = InterfaceOptions
      };

      if (IsMultiplayer)
      {
        request.ServerPorts = new PortSet { GamePort = 5000, BasePort = 5001 };
      }

      var response = await SC2Client.SendRequestAsync(new Request { JoinGame = request });

      if (response.Status == Status.InGame)
      {
        await OnGameJoined.InvokeAsync();
      }
      else
      {
        errorMessage = $"Failed to join game. Status: {response.Status}";
        if (response.Error.Count > 0)
        {
          errorMessage += " Errors: " + string.Join(", ", response.Error);
        }
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error while joining game: {ex.Message}";
    }
  }

  private void HandleOptionsChanged(InterfaceOptions options)
  {
    InterfaceOptions = options;
  }
}