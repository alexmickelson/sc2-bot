@using Web.Services
@using System.Net.WebSockets
@inject ClientManager ClientManager
@implements IDisposable

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
  @foreach (var group in ClientManager.GetAllGroups())
  {
    <div class="border border-gray-700 rounded p-4 bg-gray-900 text-white shadow-lg">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-xl font-bold text-blue-400">@group.Key</h3>
        <div class="flex items-center gap-2">
          <span class="px-2 py-1 rounded text-sm font-mono @GetStatusColor(group.SC2Client.ConnectionState)">
            websocket @group.SC2Client.ConnectionState
          </span>
          <button @onclick="() => CloseGroup(group.Key)"
            class="px-2 py-1 bg-red-900/50 hover:bg-red-900 text-white rounded text-sm transition-colors">
            Close
          </button>
        </div>
      </div>

      <div class="text-sm text-gray-400 mb-2">
        Port: @group.PlayerInfo.ClientPort
      </div>

      <div class="mt-2">
        <h4 class="font-semibold mb-1 text-gray-300 text-sm">Headless Client Logs:</h4>
        <div class="bg-black p-2 rounded text-xs h-48 overflow-y-auto font-mono text-gray-300 border border-gray-800">
          @if (string.IsNullOrEmpty(group.HeadlessClientService.Logs))
          {
            <span class="text-gray-600 italic">No logs yet...</span>
          }
          else
          {
            <pre class="whitespace-pre-wrap">@group.HeadlessClientService.Logs</pre>
          }
        </div>
      </div>
    </div>
  }
</div>

@code {
  private HashSet<ClientGroup> _knownGroups = new();

  protected override void OnInitialized()
  {
    ClientManager.OnGroupChanged += HandleGroupChanged;
    RefreshGroups();
  }

  private void HandleGroupChanged()
  {
    RefreshGroups();
    InvokeAsync(StateHasChanged);
  }

  private void RefreshGroups()
  {
    var currentGroups = new HashSet<ClientGroup>(ClientManager.GetAllGroups());

    // Find removed
    foreach (var group in _knownGroups)
    {
      if (!currentGroups.Contains(group))
      {
        UnsubscribeFromGroup(group);
      }
    }

    // Find added
    foreach (var group in currentGroups)
    {
      if (!_knownGroups.Contains(group))
      {
        SubscribeToGroup(group);
      }
    }

    _knownGroups = currentGroups;
  }

  private void CloseGroup(string key)
  {
    ClientManager.RemoveGroup(key);
  }

  private void SubscribeToGroup(ClientGroup group)
  {
    group.SC2Client.OnConnectionStateChanged += Refresh;
    group.HeadlessClientService.OnLogReceived += OnLog;
    group.HeadlessClientService.OnStateChanged += Refresh;
  }

  private void UnsubscribeFromGroup(ClientGroup group)
  {
    group.SC2Client.OnConnectionStateChanged -= Refresh;
    group.HeadlessClientService.OnLogReceived -= OnLog;
    group.HeadlessClientService.OnStateChanged -= Refresh;
  }

  private void OnLog(string log)
  {
    InvokeAsync(StateHasChanged);
  }

  private void Refresh()
  {
    InvokeAsync(StateHasChanged);
  }

  public void Dispose()
  {
    ClientManager.OnGroupChanged -= HandleGroupChanged;
    foreach (var group in _knownGroups)
    {
      UnsubscribeFromGroup(group);
    }
  }

  private string GetStatusColor(WebSocketState state) => state switch
  {
    WebSocketState.Open => "bg-green-900 text-green-300",
    WebSocketState.Closed => "bg-red-900 text-red-300",
    WebSocketState.Aborted => "bg-red-900 text-red-300",
    WebSocketState.Connecting => "bg-yellow-900 text-yellow-300",
    _ => "bg-gray-700 text-gray-300"
  };
}