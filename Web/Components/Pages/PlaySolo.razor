@page "/play-solo"
@using SC2APIProtocol
@using System.Net.WebSockets
@rendermode InteractiveServer
@inject ClientManager clientManager
@implements IDisposable

<PageTitle>Play Solo</PageTitle>

<CustomErrorBoundary>
  <ClientAndConnection Key=@Key />
</CustomErrorBoundary>

<div class="container mx-auto p-4">
  <div class="flex items-center mb-4">
    <h1 class="text-2xl font-bold text-white">Play Solo vs Bot</h1>
  </div>

  @if (IsConnectedToClient)
  {
    <CustomErrorBoundary>
      <CreateOrLeaveGame Key=@Key Type="solo" />
    </CustomErrorBoundary>

    <CustomErrorBoundary>
      <GameState Key=@Key />
    </CustomErrorBoundary>

    <CustomErrorBoundary>
      <RequestHistory Key=@Key />
    </CustomErrorBoundary>
  }
</div>

@code {

  private string Key = "Solo";
  private SC2Client sc2Client = default!;
  protected override void OnInitialized()
  {
    var group = clientManager.GetOrCreateGroup(Key);
    sc2Client = group.SC2Client;
    sc2Client.OnConnectionStateChanged += Refresh;
  }

  private void Refresh() => InvokeAsync(StateHasChanged);


  public void Dispose()
  {
    if (sc2Client is not null)
    {
      sc2Client.OnConnectionStateChanged -= Refresh;
    }
  }

  private bool IsConnectedToClient => clientManager.GetOrCreateGroup(Key).SC2Client.ConnectionState ==
  WebSocketState.Open;

}