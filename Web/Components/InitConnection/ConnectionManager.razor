@using System.Net.WebSockets
@using Web.Services
@inject ClientManager clientManager
@implements IDisposable

@if (sc2Client.ConnectionState != WebSocketState.Open)
{
  <div class="bg-gray-800/50 text-gray-50 shadow rounded-lg mb-3">
    <div class="p-4">
      <h5 class="text-lg font-medium mb-2">Connection Status</h5>
      <p>
        Status: <span class="text-red-400">@sc2Client.ConnectionState</span>
      </p>
      <button
        class="px-4 py-2 rounded font-semibold transition-colors duration-200 bg-blue-500 text-blue-50 hover:bg-blue-600"
        @onclick="ConnectToSC2">Connect to SC2 (127.0.0.1:@port)</button>
      @if (!string.IsNullOrEmpty(errorMessage))
      {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-2">@errorMessage</div>
      }
    </div>
  </div>

}

@code {
  [Parameter]
  public string Key { get; set; } = "";

  private SC2Client sc2Client = default!;
  private int port;
  private string errorMessage = "";

  protected override async Task OnInitializedAsync()
  {
    var group = clientManager.GetOrCreateGroup(Key);
    sc2Client = group.SC2Client;
    port = group.PlayerInfo.ClientPort;
    sc2Client.OnConnectionStateChanged += Refresh;

    if (sc2Client.ConnectionState != WebSocketState.Open)
    {
      await ConnectToSC2();
    }
  }

  public void Dispose()
  {
    sc2Client.OnConnectionStateChanged -= Refresh;
  }

  private void Refresh() => InvokeAsync(StateHasChanged);

  private async Task ConnectToSC2()
  {
    errorMessage = "";
    try
    {
      await sc2Client.ConnectAsync();
      await sc2Client.PingAsync();
    }
    catch (Exception ex)
    {
      errorMessage = $"Connection failed: {ex.Message}";
    }
  }
}